---
title: "PAC1"
author: "Shanrong Zhou"
date: "2022-10-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


#load packages
```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(caTools)
library(caret)
#regression tree
library(rpart); library(rpart.plot)
#bag ipred
library(ipred)
#random Forest
library(randomForest)
#ranger
library(ranger)
#gbm
library(gbm)
#xgboost
library(xgboost)
#box cox transformation and svm
library(e1071)
```

#suggestions (also read Canvas notes):
#1.data cleaning, data wrangling 
#2.splitting data into training and test set (change seed for splitting data to see whether the results can be improved)
#3.variables don't have to be in the same form, can be in different form
#4.features that i can generate from the original data
#5.modeling function / algorithm can be different

#read data
```{r}
setwd("/Users/alicezhou/Documents/Columbia/5200 Applied Analytics Frameworks & Methods I/Notes/PAC")
#read data: "stringAsFactor = F" for convenience of handling missing value, and factor variables will be created later on
data = read.csv("analysisData.csv", stringsAsFactors = F)
data$track_explicit = as.factor(data$track_explicit)
#data tidying: missing value 
data[is.na(data)] <- 0
str(data)
```

#data transformation - numetic variables
```{r}
#scaling - standardizing 
data_standardized <- data
data_standardized$track_duration = scale(data$track_duration, center=T, scale=T)
data_standardized$danceability = scale(data$danceability, center=T, scale=T)
data_standardized$energy = scale(data$energy, center=T, scale=T)
data_standardized$loudness = scale(data$loudness, center=T, scale=T)
data_standardized$speechiness = scale(data$speechiness, center=T, scale=T)
data_standardized$acousticness = scale(data$acousticness, center=T, scale=T)
data_standardized$instrumentalness = scale(data$instrumentalness, center=T, scale=T)
data_standardized$liveness = scale(data$liveness, center=T, scale=T)
data_standardized$valence = scale(data$valence, center=T, scale=T)
data_standardized$tempo = scale(data$tempo, center=T, scale=T)
str(data_standardized)
#skewness mitigation (BoxCox failed)
data_standardized %>% 
  select("track_duration","danceability","energy","loudness","speechiness","acousticness","instrumentalness","liveness","valence","tempo") %>% 
  summarise(skewness(track_duration),skewness(danceability),skewness(energy),skewness(loudness),skewness(speechiness),skewness(acousticness),skewness(instrumentalness),skewness(liveness),skewness(valence),skewness(tempo))
proc=preProcess(data_standardized[, c("track_duration","danceability","energy","loudness","speechiness","acousticness","instrumentalness","liveness","valence","tempo")], method = "BoxCox")
proc$bc
```
#new feature creation / data wrangling - categorical variables
```{r}
#add genre variables (round 1)
data1 <- data
data1$rhythm_and_blues <- as.factor(ifelse(test = str_detect(data1$genre, 'rhythm and blues'), "YES", "NO"))
data1$pop <- as.factor(ifelse(test = str_detect(data1$genre, 'pop'), "YES", "NO"))
data1$southern_soul <- as.factor(ifelse(test = str_detect(data1$genre, 'southern soul'), "YES", "NO"))
data1$dance_pop <- as.factor(ifelse(test = str_detect(data1$genre, 'dance pop'), "YES", "NO"))
data1$pop_rock <- as.factor(ifelse(test = str_detect(data1$genre, 'pop rock'), "YES", "NO"))
data1$doo_wop <- as.factor(ifelse(test = str_detect(data1$genre, 'doo-wop'), "YES", "NO"))
data1$rb <- as.factor(ifelse(test = str_detect(data1$genre, 'rb'), "YES", "NO"))
data1$post_teen_pop <- as.factor(ifelse(test = str_detect(data1$genre, 'post-teen pop'), "YES", "NO"))
data1$post_grunge <- as.factor(ifelse(test = str_detect(data1$genre, 'post-grunge'), "YES", "NO"))
data1$neo_mellow <- as.factor(ifelse(test = str_detect(data1$genre, 'neo mellow'), "YES", "NO"))
data1$vocal_jazz <- as.factor(ifelse(test = str_detect(data1$genre, 'vocal jazz'), "YES", "NO"))
#add genre variables (round 2)
data1$pop_rap <- as.factor(ifelse(test = str_detect(data1$genre, 'pop rap'), "YES", "NO"))
data1$hip_pop <- as.factor(ifelse(test = str_detect(data1$genre, 'hip pop'), "YES", "NO"))
data1$classic_soul <- as.factor(ifelse(test = str_detect(data1$genre, 'classic soul'), "YES", "NO"))
data1$rockabilly <- as.factor(ifelse(test = str_detect(data1$genre, 'rockabilly'), "YES", "NO"))
data1$easy_listening <- as.factor(ifelse(test = str_detect(data1$genre, 'easy listening'), "YES", "NO"))
data1$permanent_wave <- as.factor(ifelse(test = str_detect(data1$genre, 'permanent wave'), "YES", "NO"))
data1$canadian_pop <- as.factor(ifelse(test = str_detect(data1$genre, 'canadian pop'), "YES", "NO"))
#add genre variables (round 3)
data1$alternative_metal <- as.factor(ifelse(test = str_detect(data1$genre, 'alternative metal'), "YES", "NO"))
data1$nashville_sound <- as.factor(ifelse(test = str_detect(data1$genre, 'nashville sound'), "YES", "NO"))
data1$philly_soul <- as.factor(ifelse(test = str_detect(data1$genre, 'philly soul'), "YES", "NO"))
data1$modern_rock <- as.factor(ifelse(test = str_detect(data1$genre, 'modern rock'), "YES", "NO"))
data1$chicago_soul <- as.factor(ifelse(test = str_detect(data1$genre, 'chicago soul'), "YES", "NO"))
data1$melodic_rap <- as.factor(ifelse(test = str_detect(data1$genre, 'melodic rap'), "YES", "NO"))
data1$northern_soul <- as.factor(ifelse(test = str_detect(data1$genre, 'northern soul'), "YES", "NO"))
data1$piano_rock <- as.factor(ifelse(test = str_detect(data1$genre, 'piano rock'), "YES", "NO"))
data1$boy_band <- as.factor(ifelse(test = str_detect(data1$genre, 'boy band'), "YES", "NO"))
data1$deep_adult_standards <- as.factor(ifelse(test = str_detect(data1$genre, 'deep adult standards'), "YES", "NO"))
data1$nu_metal <- as.factor(ifelse(test = str_detect(data1$genre, 'nu metal'), "YES", "NO"))
data1$soul_blues <- as.factor(ifelse(test = str_detect(data1$genre, 'soul blues'), "YES", "NO"))
data1$jazz_blues <- as.factor(ifelse(test = str_detect(data1$genre, 'jazz blues'), "YES", "NO"))
data1$classic_garage_rock <- as.factor(ifelse(test = str_detect(data1$genre, 'classic garage rock'), "YES", "NO"))
data1$electropop <- as.factor(ifelse(test = str_detect(data1$genre, 'electropop'), "YES", "NO"))
data1$girl_group <- as.factor(ifelse(test = str_detect(data1$genre, 'girl group'), "YES", "NO"))
data1$chicago_rap <- as.factor(ifelse(test = str_detect(data1$genre, 'chicago rap'), "YES", "NO"))
data1$toronto_rap <- as.factor(ifelse(test = str_detect(data1$genre, 'toronto rap'), "YES", "NO"))
data1$tropical_house <- as.factor(ifelse(test = str_detect(data1$genre, 'tropical house'), "YES", "NO"))
data1$g_funk <- as.factor(ifelse(test = str_detect(data1$genre, 'g funk'), "YES", "NO"))
data1$blues <- as.factor(ifelse(test = str_detect(data1$genre, 'blues'), "YES", "NO"))

#add performer variables (round 1)
data2 <- data1
data2$Madonna <- as.factor(ifelse(data2$performer=='Madonna', "YES", "NO"))
data2$Brook_Benton <- as.factor(ifelse(data2$performer=='Brook Benton', "YES", "NO"))
data2$The_Weeknd <- as.factor(ifelse(data2$performer=='The Weeknd', "YES", "NO"))
data2$The_Beatles <- as.factor(ifelse(data2$performer=='The Beatles', "YES", "NO"))
data2$Elton_John <- as.factor(ifelse(data2$performer=='Elton John', "YES", "NO"))
data2$Taylor_Swift <- as.factor(ifelse(data2$performer=='Taylor Swift', "YES", "NO"))
data2$The_Rolling_Stones <- as.factor(ifelse(data2$performer=='The Rolling Stones', "YES", "NO"))
data2$Billy_Joel <- as.factor(ifelse(data2$performer=='Billy Joel', "YES", "NO"))
data2$Drake <- as.factor(ifelse(data2$performer=='Drake', "YES", "NO"))
#add performer variables (round 2)
data2$Jackie_Wilson <- as.factor(ifelse(data2$performer=='Jackie Wilson', "YES", "NO"))
data2$Stevie_Wonder <- as.factor(ifelse(data2$performer=='Stevie Wonder', "YES", "NO"))
data2$Justin_Bieber <- as.factor(ifelse(data2$performer=='Justin Bieber', "YES", "NO"))
data2$Keith_rban <- as.factor(ifelse(data2$performer=='Keith Urban', "YES", "NO"))
data2$Glee_Cast <- as.factor(ifelse(data2$performer=='Glee Cast', "YES", "NO"))
data2$Kenny_Chesney <- as.factor(ifelse(data2$performer=='Kenny Chesney', "YES", "NO"))
#add performer variables (round 3)
data2$Luke_Bryan <- as.factor(ifelse(data2$performer=='Luke Bryan', "YES", "NO"))
data2$Ariana_Grande <- as.factor(ifelse(data2$performer=='Ariana Grande', "YES", "NO"))
data2$Fats_Domino <- as.factor(ifelse(data2$performer=='Fats Domino', "YES", "NO"))
data2$Eminem <- as.factor(ifelse(data2$performer=='Eminem', "YES", "NO"))
data2$Mariah_Carey <- as.factor(ifelse(data2$performer=='Mariah Carey', "YES", "NO"))
data2$Michael_Jackson <- as.factor(ifelse(data2$performer=='Michael Jackson', "YES", "NO"))
data2$Kanye_West <- as.factor(ifelse(data2$performer=='Kanye West', "YES", "NO"))
data2$Juice_WRLD <- as.factor(ifelse(data2$performer=='Juice WRLD', "YES", "NO"))
data2$Johnny_Mathis <- as.factor(ifelse(data2$performer=='Johnny Mathis', "YES", "NO"))
data2$Beyonce <- as.factor(ifelse(data2$performer=='Beyonce', "YES", "NO"))
data2$Daryl_Hall_John_Oates <- as.factor(ifelse(data2$performer=='Daryl Hall John Oates', "YES", "NO"))
data2$Wilson_Pickett <- as.factor(ifelse(data2$performer=='Wilson Pickett', "YES", "NO"))
data2$Jason_Aldean <- as.factor(ifelse(data2$performer=='Jason Aldean', "YES", "NO"))
data2$Carrie_Underwood <- as.factor(ifelse(data2$performer=='Carrie Underwood', "YES", "NO"))

data3 <- data2 %>% select(-performer) %>% select(-song) %>% select(-genre)
str(data3)
```

#split dataset
```{r}
set.seed(617)
split=sample.split(data3$rating, SplitRatio = 0.7)
train=data3[split,]
test=data3[!split,]
```

#feature selection
```{r}
start_mod = lm(rating~1,data=data3)
empty_mod = lm(rating~1,data=data3)
full_mod = lm(rating~.-id,data=data3)
hybridStepwise = step(start_mod,
                      scope=list(upper=full_mod,lower=empty_mod),
                      direction='both')
```

#linear regression (done, without split)
```{r}
model_lm = lm(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop,train)

pred_train=predict(model_lm)
rmse_train=sqrt(mean((pred_train-train$rating)^2)); rmse_train
pred_test=predict(model_lm, newdata=test)
rmse_test=sqrt(mean((pred_test-test$rating)^2)); rmse_test
```
#regression tree
```{r}
model_tree = rpart(rating~.-id, method = 'anova')
rpart.plot(model_tree)
```
#tuned tree (done, without split)
```{r}
tuneGrid=expand.grid(cp=seq(0,0.1,0.0001))
trControl=trainControl(method="cv",number=5)
set.seed(1031)
tree_cv=train(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop,
              data=data3,
              method="rpart", 
              trControl=trControl,
              tuneGrid=tuneGrid)
tree_cv$bestTune
model_tuned_tree=rpart(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop, 
             data=data3, 
             method="anova",
             cp=tree_cv$bestTune)
pred=predict(model_tuned_tree)
rmse=sqrt(mean((pred-data3$rating)^2)); rmse
```
#bag_ipred
```{r}
set.seed(1031) 
bag_ipred = bagging(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    The_Rolling_Stones + post_grunge + time_signature + Elton_John + 
    track_explicit + vocal_jazz + Taylor_Swift + Billy_Joel + 
    liveness + The_Weeknd + tempo + doo_wop + Madonna + Drake + 
    speechiness,
              data = data3, 
              nbagg = 1000)
pred = predict(bag_ipred)
rmse_bag_ipred = sqrt(mean((pred - data3$rating)^2)); rmse_bag_ipred
```
#bag_randomforest (done, without split) 
```{r}
set.seed(1031)
bag = randomForest(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop, 
                   data=data3, 
                   mtry = 12,
                   ntree = 1000)
pred = predict(bag)
rmse_bag_randomforest = sqrt(mean((pred - data3$rating)^2)); rmse_bag_randomforest
```
#tuned random forest (done, without split)
```{r}
trControl = trainControl(method = 'cv', number = 5)
tuneGrid = expand.grid(mtry = 36)
set.seed(1031)
forest_cv = train(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop, 
                  data = data3, 
                  method = 'rf', 
                  trControl = trControl, 
                  tuneGrid = tuneGrid, 
                  ntree = 1000)
forest_cv$bestTune$mtry

set.seed(1031)
cvforest = randomForest(rating~ddance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop,  
                        data3, 
                        mtry = forest_cv$bestTune$mtry, 
                        ntree = 1000)

pred = predict(cvforest)
rmse_cv_forest = sqrt(mean((pred - data3$rating)^2)); rmse_cv_forest
```
#tuned forest ranger (running, with split) [best]
```{r}
trControl=trainControl(method="cv",number=5)
tuneGrid = expand.grid(mtry=36, 
                       splitrule = c('variance','extratrees','maxstat'), 
                       min.node.size = c(2,5,10,15,20,25))
set.seed(1031)
cvModel = train(rating ~ dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    energy + rhythm_and_blues + The_Beatles + instrumentalness + 
    Glee_Cast + deep_adult_standards + permanent_wave + chicago_rap + 
    The_Rolling_Stones + time_signature + post_grunge + Elton_John + 
    vocal_jazz + Luke_Bryan + Michael_Jackson + classic_garage_rock + 
    Billy_Joel + Taylor_Swift + track_explicit + modern_rock + 
    Stevie_Wonder + liveness + Daryl_Hall_John_Oates + The_Weeknd + 
    melodic_rap + g_funk + Jason_Aldean + nashville_sound + Mariah_Carey + 
    tempo + Drake + doo_wop + Johnny_Mathis + Keith_rban + Kenny_Chesney + 
    Madonna + chicago_soul + classic_soul + post_teen_pop + speechiness + 
    northern_soul + philly_soul + Kanye_West + Beyonce + soul_blues + 
    blues + Juice_WRLD + nu_metal + boy_band + tropical_house,
                data=data3,
                method="ranger",
                num.trees=1000,
                trControl=trControl,
                tuneGrid=tuneGrid)
cvModel$bestTune

set.seed(1031)
cv_forest_ranger = ranger(rating ~ dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    energy + rhythm_and_blues + The_Beatles + instrumentalness + 
    Glee_Cast + deep_adult_standards + permanent_wave + chicago_rap + 
    The_Rolling_Stones + time_signature + post_grunge + Elton_John + 
    vocal_jazz + Luke_Bryan + Michael_Jackson + classic_garage_rock + 
    Billy_Joel + Taylor_Swift + track_explicit + modern_rock + 
    Stevie_Wonder + liveness + Daryl_Hall_John_Oates + The_Weeknd + 
    melodic_rap + g_funk + Jason_Aldean + nashville_sound + Mariah_Carey + 
    tempo + Drake + doo_wop + Johnny_Mathis + Keith_rban + Kenny_Chesney + 
    Madonna + chicago_soul + classic_soul + post_teen_pop + speechiness + 
    northern_soul + philly_soul + Kanye_West + Beyonce + soul_blues + 
    blues + Juice_WRLD + nu_metal + boy_band + tropical_house,
                          data=data3,
                          num.trees = 1000, 
                          mtry=cvModel$bestTune$mtry, 
                          min.node.size = cvModel$bestTune$min.node.size, 
                          splitrule = cvModel$bestTune$splitrule)

pred = predict(cv_forest_ranger, data = data3, num.trees = 1000)
rmse_cv_forest_ranger = sqrt(mean((pred$predictions - data3$rating)^2)); rmse_cv_forest_ranger
```
#xgboost
```{r}
library(xgboost)
xgboost = xgboost(data=as.matrix(data[5:19]), 
                  label = data$rating,
                  nrounds=10000,
                  verbose = 0,
                  early_stopping_rounds = 100)
xgboost$best_iteration
pred = predict(xgboost, newdata = as.matrix(data[5:19]))
rmse_xgboost = sqrt(mean((pred - data$rating)^2)); rmse_xgboost
```
#tuned gbm (done, with split)
```{r}
set.seed(1031)
trControl = trainControl(method="cv",number=5)
tuneGrid = expand.grid(n.trees = 500, 
                       interaction.depth = c(1,2,3),
                       shrinkage = (1:100)*0.001,
                       n.minobsinnode=c(5,10,15))
garbage = capture.output(cvModel <- train(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop,
                                          data=train,
                                          method="gbm",
                                          trControl=trControl, 
                                          tuneGrid=tuneGrid))

set.seed(1031)
cvboost = gbm(rating~dance_pop + acousticness + valence + danceability + 
    loudness + pop_rock + southern_soul + track_duration + pop + 
    The_Beatles + rhythm_and_blues + instrumentalness + energy + 
    Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + 
    Elton_John + post_grunge + vocal_jazz + track_explicit + 
    Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + 
    The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + 
    Madonna + classic_soul + speechiness + post_teen_pop,
              data=train,
              distribution="gaussian",
              n.trees=500,
              interaction.depth=cvModel$bestTune$interaction.depth,
              shrinkage=cvModel$bestTune$shrinkage,
              n.minobsinnode = cvModel$bestTune$n.minobsinnode)

pred = predict(cvboost, n.trees=500)
rmse_cv_boost = sqrt(mean((pred - train$rating)^2)); rmse_cv_boost
```

#for svm, catogorical variables need to be dummy coded
#svm-linear
```{r}
set.seed(617)
svmLinear=svm(rating~ Madonna + energy, 
              data=train, 
              kernel="linear",
              type="C-classification")
pred=predict(svmLinear, newdata=test)
table(pred, test$rating)
plot(svmLinear, test[, c("rating", "rhythm_and_blue", "Madonna","energy")])
```
#svm-radial
```{r}
svmRadialTune = tune(factor(rating)~dance_pop + acousticness + valence + danceability + loudness + pop_rock + southern_soul + track_duration + pop + The_Beatles + rhythm_and_blues + instrumentalness + energy + Glee_Cast + permanent_wave + The_Rolling_Stones + time_signature + Elton_John + post_grunge + vocal_jazz + track_explicit + Taylor_Swift + Billy_Joel + Stevie_Wonder + liveness + doo_wop + The_Weeknd + tempo + pop_rap + Drake + Keith_rban + Kenny_Chesney + Madonna + classic_soul + speechiness + post_teen_pop,
                     data=train,
                     METHOD = "svm",
                     kernel="radial",
                     type="C-classification",
                     ranges = list(cost=c(0.1,10,100),gamma=c(1,10),coef0=c(0.1,1,10)))

pred_train = predict(svmRadialTune$best.mode)
table(pred_train,train$rating)
mean(pred==train$rating)
pred = predict(svmRadialTune$best.model, newdata=test)
table(pred,test$rating)
mean(pred==test$rating)
```

#test the rmse
```{r}
pred_train=predict(cv_forest_ranger, data = train, num.trees = 1000)
rmse_train=sqrt(mean((pred_train$predictions-train$rating)^2)); rmse_train
pred_test=predict(cv_forest_ranger, data = test, num.trees = 1000)
rmse_test=sqrt(mean((pred_test$predictions-test$rating)^2)); rmse_test
```

#fit in scoringData
```{r}
#read data
scoringData = read.csv("scoringData.csv", stringsAsFactors = F)
#data tidying: missing value 
scoringData[is.na(scoringData)] <- 0
#add genre variables
scoringdata1 <- scoringData
scoringdata1$rhythm_and_blues <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'rhythm and blues'), "YES", "NO"))
scoringdata1$pop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'pop'), "YES", "NO"))
scoringdata1$southern_soul <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'southern soul'), "YES", "NO"))
scoringdata1$dance_pop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'dance pop'), "YES", "NO"))
scoringdata1$pop_rock <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'pop rock'), "YES", "NO"))
scoringdata1$doo_wop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'doo-wop'), "YES", "NO"))
scoringdata1$rb <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'rb'), "YES", "NO"))
scoringdata1$post_teen_pop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'post-teen pop'), "YES", "NO"))
scoringdata1$post_grunge <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'post-grunge'), "YES", "NO"))
scoringdata1$neo_mellow <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'neo mellow'), "YES", "NO"))
scoringdata1$vocal_jazz <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'vocal jazz'), "YES", "NO"))
#add genre variables (round 2)
scoringdata1$pop_rap <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'pop rap'), "YES", "NO"))
scoringdata1$hip_pop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'hip pop'), "YES", "NO"))
scoringdata1$classic_soul <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'classic soul'), "YES", "NO"))
scoringdata1$rockabilly <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'rockabilly'), "YES", "NO"))
scoringdata1$easy_listening <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'easy listening'), "YES", "NO"))
scoringdata1$permanent_wave <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'permanent wave'), "YES", "NO"))
scoringdata1$canadian_pop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'canadian pop'), "YES", "NO"))
#add genre variables (round 3)
scoringdata1$alternative_metal <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'alternative metal'), "YES", "NO"))
scoringdata1$nashville_sound <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'nashville sound'), "YES", "NO"))
scoringdata1$philly_soul <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'philly soul'), "YES", "NO"))
scoringdata1$modern_rock <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'modern rock'), "YES", "NO"))
scoringdata1$chicago_soul <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'chicago soul'), "YES", "NO"))
scoringdata1$melodic_rap <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'melodic rap'), "YES", "NO"))
scoringdata1$northern_soul <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'northern soul'), "YES", "NO"))
scoringdata1$piano_rock <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'piano rock'), "YES", "NO"))
scoringdata1$boy_band <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'boy band'), "YES", "NO"))
scoringdata1$deep_adult_standards <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'deep adult standards'), "YES", "NO"))
scoringdata1$nu_metal <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'nu metal'), "YES", "NO"))
scoringdata1$soul_blues <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'soul blues'), "YES", "NO"))
scoringdata1$jazz_blues <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'jazz blues'), "YES", "NO"))
scoringdata1$classic_garage_rock <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'classic garage rock'), "YES", "NO"))
scoringdata1$electropop <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'electropop'), "YES", "NO"))
scoringdata1$girl_group <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'girl group'), "YES", "NO"))
scoringdata1$chicago_rap <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'chicago rap'), "YES", "NO"))
scoringdata1$toronto_rap <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'toronto rap'), "YES", "NO"))
scoringdata1$tropical_house <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'tropical house'), "YES", "NO"))
scoringdata1$g_funk <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'g funk'), "YES", "NO"))
scoringdata1$blues <- as.factor(ifelse(test = str_detect(scoringdata1$genre, 'blues'), "YES", "NO"))

#add performer variables
scoringdata2 <- scoringdata1
scoringdata2$Madonna <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'Madonna'), "YES", "NO"))
scoringdata2$Brook_Benton <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'Brook Benton'), "YES", "NO"))
scoringdata2$The_Weeknd <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'The Weeknd'), "YES", "NO"))
scoringdata2$The_Beatles <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'The Beatles'), "YES", "NO"))
scoringdata2$Elton_John <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'Elton John'), "YES", "NO"))
scoringdata2$Taylor_Swift <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'Taylor Swift'), "YES", "NO"))
scoringdata2$The_Rolling_Stones <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'The Rolling Stones'), "YES", "NO"))
scoringdata2$Billy_Joel <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'Billy Joel'), "YES", "NO"))
scoringdata2$Drake <- as.factor(ifelse(test = str_detect(scoringdata2$performer, 'Drake'), "YES", "NO"))
#add performer variables (round 2)
scoringdata2$Jackie_Wilson <- as.factor(ifelse(scoringdata2$performer=='Jackie Wilson', "YES", "NO"))
scoringdata2$Stevie_Wonder <- as.factor(ifelse(scoringdata2$performer=='Stevie Wonder', "YES", "NO"))
scoringdata2$Justin_Bieber <- as.factor(ifelse(scoringdata2$performer=='Justin Bieber', "YES", "NO"))
scoringdata2$Keith_rban <- as.factor(ifelse(scoringdata2$performer=='Keith Urban', "YES", "NO"))
scoringdata2$Glee_Cast <- as.factor(ifelse(scoringdata2$performer=='Glee Cast', "YES", "NO"))
scoringdata2$Kenny_Chesney <- as.factor(ifelse(scoringdata2$performer=='Kenny Chesney', "YES", "NO"))
#add performer variables (round 3)
scoringdata2$Luke_Bryan <- as.factor(ifelse(scoringdata2$performer=='Luke Bryan', "YES", "NO"))
scoringdata2$Ariana_Grande <- as.factor(ifelse(scoringdata2$performer=='Ariana Grande', "YES", "NO"))
scoringdata2$Fats_Domino <- as.factor(ifelse(scoringdata2$performer=='Fats Domino', "YES", "NO"))
scoringdata2$Eminem <- as.factor(ifelse(scoringdata2$performer=='Eminem', "YES", "NO"))
scoringdata2$Mariah_Carey <- as.factor(ifelse(scoringdata2$performer=='Mariah Carey', "YES", "NO"))
scoringdata2$Michael_Jackson <- as.factor(ifelse(scoringdata2$performer=='Michael Jackson', "YES", "NO"))
scoringdata2$Kanye_West <- as.factor(ifelse(scoringdata2$performer=='Kanye West', "YES", "NO"))
scoringdata2$Juice_WRLD <- as.factor(ifelse(scoringdata2$performer=='Juice WRLD', "YES", "NO"))
scoringdata2$Johnny_Mathis <- as.factor(ifelse(scoringdata2$performer=='Johnny Mathis', "YES", "NO"))
scoringdata2$Beyonce <- as.factor(ifelse(scoringdata2$performer=='Beyonce', "YES", "NO"))
scoringdata2$Daryl_Hall_John_Oates <- as.factor(ifelse(scoringdata2$performer=='Daryl Hall John Oates', "YES", "NO"))
scoringdata2$Wilson_Pickett <- as.factor(ifelse(scoringdata2$performer=='Wilson Pickett', "YES", "NO"))
scoringdata2$Jason_Aldean <- as.factor(ifelse(scoringdata2$performer=='Jason Aldean', "YES", "NO"))
scoringdata2$Carrie_Underwood <- as.factor(ifelse(scoringdata2$performer=='Carrie Underwood', "YES", "NO"))

#delete unused data
scoringdata3 <- scoringdata2 %>% select(-performer) %>% select(-song) %>% select(-genre)
str(scoringdata3)
#double check [NA] data 
filter(scoringdata3, id==24589)
```
#generate outcome
```{r}
pred = predict(cv_forest_ranger, data=scoringdata3, n.trees = 1000)
submissionFile=data.frame(id=scoringdata3$id,rating=pred$predictions)
write.csv(submissionFile, file="submission_Nov13.csv", row.names=F)
```

